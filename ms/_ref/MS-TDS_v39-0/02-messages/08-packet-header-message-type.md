### Packet Header Message Type Stream Definition

#### Bulk Load BCP

**Stream Name:**

458. BulkLoadBCP

**Stream Function:**

Describes the format of bulk-loaded data through the **\"INSERT BULK\"**
T-SQL statement. The format is a COLMETADATA token (section
[2.2.7.4](#Section_58880b9f381c43b2bf8b0727a98c4f4c)) describing the
data being sent, followed by multiple ROW tokens (section
[2.2.7.20](#Section_3840ef933b104aca9fd1a210b8bb6d0c)), ending with a
DONE token (section
[2.2.7.6](#Section_3c06f11098bd4d5bb836b1ba66452cb7)). The stream is
equivalent to that produced by the server if it were sending the same
rowset on output.

**Stream Comments:**

-   Packet header type is 0x07.

-   This message sent to the server contains bulk data to be inserted.
    The client MUST have previously notified the server where this data
    is to be inserted. For more information about the INSERT BULK
    syntax, see
    [\[MSDN-INSERT\]](https://go.microsoft.com/fwlink/?LinkId=154273).

-   A sample BulkLoadBCP message is in section
    [4.12](#Section_43dac55aa31a4122ac0620cfedf76811).

**Stream-Specific Rules:**

459. BulkLoad_METADATA = COLMETADATA

     BulkLoad_ROW = ROW

     BulkLoad_DONE = DONE

**Submessage Definition:**

462. BulkLoadBCP = BulkLoad_METADATA

     \*BulkLoad_ROW

     BulkLoad_DONE

Note that for INSERT BULK operations, XMLTYPE is to be sent as
NVARCHAR(N) or NVARCHAR(MAX) data type. An error is produced if XMLTYPE
is specified.

INSERT BULK operations for data type UDTTYPE is not supported. Use
VARBINARYTYPE to insert instances of User Defined Types.

INSERT BULK operations do not support type specifications of DECIMALTYPE
and NUMERICTYPE. To insert these data types, use DECIMALNTYPE and
NUMERICNTYPE.

#### Bulk Load Update Text/Write Text

**Stream Name:**

465. BulkLoadUTWT

**Stream Function:**

Describes the format of bulk-loaded data with UpdateText or WriteText.
The format is the length of the data followed by the data itself.

**Stream Comments:**

-   Packet header type 0x07.

-   This message sent to the server contains bulk data to be inserted.
    The client MUST have previously issued an **\"UPDATETEXT BULK\"** or
    **\"WRITETEXT BULK\"** T-SQL statement to the server. For
    information about the UPDATETEXT BULK and WRITETEXT BULK syntax, see
    [\[MSDN-UPDATETEXT\]](https://go.microsoft.com/fwlink/?LinkId=154272)
    and
    [\[MSDN-WRITETEXT\]](https://go.microsoft.com/fwlink/?LinkId=154269),
    respectively.

-   The server returns a RETURNVALUE token (section
    [2.2.7.19](#Section_7091f6f6b83d4ed2afebba5013dfb18f)) containing
    the new time stamp for this column.

**Stream-Specific Rules:**

466. BulkData = L_VARBYTE

**Sub Message Definition:**

467. BulkLoadUTWT = BulkData

**Stream Parameter Details**

  -----------------------------------------------------------------------
  Parameter   Description
  ----------- -----------------------------------------------------------
  BulkData    Contains the BulkData length and BulkData data within the
              L_VARBYTE.

  -----------------------------------------------------------------------

#### Federated Authentication Token

**Stream Name:**

468. FEDAUTH

**Stream Function:**

An authentication token for [**federated
authentication**](#gt_5ae22a0e-5ff4-441b-80d4-224ef4dd4d19).[\<16\>](\l)

**Stream Comments:**

-   Packet header type 0x08.

-   This stream contains the client's federated authentication token,
    generated by a client library that is supported by the server, and
    any other information, as laid out in the rules for the particular
    bFedAuthLibrary that is indicated in the FEDAUTH FeatureExt in the
    Login message.

-   The server MUST respond with a Login Response message or an error.

**Stream-Specific Rules:**

469. DataLen = DWORD

     FedAuthToken = L_VARBYTE

     Nonce = 32BYTE

**Stream Definition:**

Stream is defined based on the bFedAuthLibrary that is used in Login
message FEDAUTH FeatureExt. This message MUST not be sent for any values
of bFedAuthLibrary that are not listed in this section.

When bFedAuthLibrary is [**Azure Active Directory Authentication Library
(ADAL)**](#gt_5a728127-a59d-4cf9-8ab5-4a4e0747cc51) \[that is, 0x02\]:

474. FEDAUTH = DataLen

     FedAuthToken

     \[Nonce\]

**Stream Parameter Details**

  ---------------------------------------------------------------------------
  Parameter      Description
  -------------- ------------------------------------------------------------
  DataLen        The total length of the data in the Federated Authentication
                 Token message that follows this field. DataLen does not
                 include the size that is used for the DataLen field itself.

  FedAuthToken   Contains the federated authentication token data that is
                 generated by the federated authentication library. The
                 federated authentication library that is used to generate
                 the token MUST be the same library that is specified as
                 bFedAuthLibrary in the client's Login FEDAUTH FeatureExt
                 message.

  Nonce          The nonce, if provided by the server during the pre-login
                 exchange, that is echoed back to the server by the client.
                 If the server provided a nonce in the pre-login exchange,
                 the client MUST echo the nonce back to the server in this
                 field. If the server did not provide a nonce to the client
                 in the pre-login exchange, this field MUST NOT be included
                 in the stream.
  ---------------------------------------------------------------------------

#### LOGIN7

**Stream Name:**

477. LOGIN7

**Stream Function:**

Defines the authentication rules for use between client and server.

**Stream Comments:**

-   Packet header type 0x10.

-   The length of a LOGIN7 stream MUST NOT be longer than 128K-1(byte)
    bytes.

-   The OffsetLength and Data rules define the variable-length portions
    of this data stream. The OffsetLength rule lists the offset from the
    start of the structure, and the length for each parameter. If the
    parameter is not used, the parameter length field MUST be 0. The
    data itself (for example, the Data rule) follows these parameters.

-   The first parameter of the OffsetLength rule (ibHostName) indicates
    the start of the variable length portion of this data stream. As
    such it MUST NOT be 0. This is required for forward compatibility
    (for example, later versions of TDS, with additional parameters, can
    be successfully skipped by down-level servers).

-   A sample LOGIN7 message is in section
    [4.2](#Section_ce5ad23f6bf84fa594266b0d36e14da2).

**Stream-Specific Rules:**

478. Length = DWORD

     TDSVersion = DWORD

     PacketSize = DWORD

     ClientProgVer = DWORD

     ClientPID = DWORD

     ConnectionID = DWORD

     fByteOrder = BIT

     fChar = BIT

     fFloat = 2BIT

     fDumpLoad = BIT

     fUseDB = BIT

     fDatabase = BIT

     fSetLang = BIT

     OptionFlags1 = fByteOrder

     fChar

     fFloat

     fDumpLoad

     fUseDB

     fDatabase

     fSetLang

     fLanguage = BIT

     fODBC = BIT

     fTranBoundary = BIT ; (removed in TDS 7.2)

     fCacheConnect = BIT ; (removed in TDS 7.2)

     fUserType = 3BIT

     fIntSecurity = BIT

     OptionFlags2 = fLanguage

     fODBC

     (fTranBoundary / FRESERVEDBIT)

     (fCacheConnect / FRESERVEDBIT)

     fUserType

     fIntSecurity

     fSQLType = 4BIT

     fOLEDB = BIT ; (introduced in TDS 7.2)

     fReadOnlyIntent = BIT ; (introduced in TDS 7.4)

     TypeFlags = fSQLType

     (FRESERVEDBIT / fOLEDB)

     (FRESERVEDBIT / fReadOnlyIntent)

     2FRESERVEDBIT

     fChangePassword = BIT ; (introduced in TDS 7.2)

     fUserInstance = BIT ; (introduced in TDS 7.2)

     fSendYukonBinaryXML = BIT ; (introduced in TDS 7.2)

     fUnknownCollationHandling = BIT ; (introduced in TDS 7.3)

     fExtension = BIT ; (introduced in TDS 7.4)

     OptionFlags3 = (FRESERVEDBIT / fChangePassword)

     (FRESERVEDBIT / fSendYukonBinaryXML)

     (FRESERVEDBIT / fUserInstance)

     (FRESERVEDBIT / fUnknownCollationHandling)

     (FRESERVEDBIT / fExtension)

     3FRESERVEDBIT

     ClientTimeZone = LONG;

     ClientLCID = LCID

     ColFlags

     Version

     ibHostName = USHORT

     cchHostName = USHORT

     ibUserName = USHORT

     cchUserName = USHORT

     ibPassword = USHORT

     cchPassword = USHORT

     ibAppName = USHORT

     cchAppName = USHORT

     ibServerName = USHORT

     cchServerName = USHORT

     ibUnused = USHORT

     cbUnused = USHORT

     ibExtension = USHORT ; (introduced in TDS 7.4)

     cbExtension = USHORT ; (introduced in TDS 7.4)

     ibCltIntName = USHORT

     cchCltIntName = USHORT

     ibLanguage = USHORT

     cchLanguage = USHORT

     ibDatabase = USHORT

     cchDatabase = USHORT

     ClientID = 6BYTE

     ibSSPI = USHORT

     cbSSPI = USHORT

     ibAtchDBFile = USHORT

     cchAtchDBFile = USHORT

     ibChangePassword = USHORT ; (introduced in TDS 7.2)

     cchChangePassword = USHORT ; (introduced in TDS 7.2)

     cbSSPILong = DWORD ; (introduced in TDS 7.2)

     OffsetLength = ibHostName

     cchHostName

     ibUserName

     cchUserName

     ibPassword

     cchPassword

     ibAppName

     cchAppName

     ibServerName

     cchServerName

     (ibUnused / ibExtension)

     (cchUnused / cbExtension)

     ibCltIntName

     cchCltIntName

     ibLanguage

     cchLanguage

     ibDatabase

     cchDatabase

     ClientID

     ibSSPI

     cbSSPI

     ibAtchDBFile

     cchAtchDBFile

     ibChangePassword

     cchChangePassword

     cbSSPILong

**Note**  The ClientLCID value is no longer used to set language
parameters and is ignored.

All variable-length fields in the login record are optional. This means
that the length of the field can be specified as 0. If the length is
specified as 0, then the offset MUST be ignored. The only exception is
ibHostName, which MUST always point to the beginning of the
variable-length data in the login record even in the case where no
variable-length data is included.

597. Data = \*BYTE

     FeatureId = BYTE ; (introduced in TDS 7.4)

     FeatureDataLen = DWORD ; (introduced in TDS 7.4)

     FeatureData = \*BYTE ; (introduced in TDS 7.4)

     TERMINATOR = %xFF ; signal of end of feature option

     FeatureOpt = (FeatureId

     FeatureDataLen

     FeatureData)

     /

     TERMINATOR

     FeatureExt = 1\*FeatureOpt ; (introduced in TDS 7.4)

**Stream Definition:**

612. LOGIN7 = Length

     TDSVersion

     PacketSize

     ClientProgVer

     ClientPID

     ConnectionID

     OptionFlags1

     OptionFlags2

     TypeFlags

     (FRESERVEDBYTE / OptionFlags3)

     ClientTimeZone

     ClientLCID

     OffsetLength

     Data

     \[FeatureExt\]

**Stream Parameter Details**

+----------+-----------------------------------------------------------+
| P        | Description                                               |
| arameter |                                                           |
+==========+===========================================================+
| Length   | The total length of the LOGIN7 structure.                 |
+----------+-----------------------------------------------------------+
| TD       | The highest TDS version being used by the client (for     |
| SVersion | example, 0x00000071 for TDS 7.1). If the TDSVersion value |
|          | sent by the client is greater than the value that the     |
|          | server recognizes, the server MUST use the highest TDS    |
|          | version that it can use. This provides a mechanism for    |
|          | clients to discover the server TDS by sending a standard  |
|          | LOGIN7 message. If the TDSVersion value sent by the       |
|          | client is lower than the highest TDS version the server   |
|          | recognizes, the server MUST use the TDS version sent by   |
|          | the client.[\<17\>](\l)                                   |
|          |                                                           |
|          | For information about what the server sends to the        |
|          | client, see the LOGINACK token (section                   |
|          | [2.2.7.14](#Section_490e563dcc6e4c86bb95ef0186b98032)).   |
+----------+-----------------------------------------------------------+
| Pa       | The packet size being requested by the client.            |
| cketSize |                                                           |
+----------+-----------------------------------------------------------+
| Clien    | The version of the                                        |
| tProgVer | [**interface**](#gt_95913fbd-3262-47ae-b5eb-18e6806824b9) |
|          | library (for example, ODBC or OLEDB) being used by the    |
|          | client.                                                   |
+----------+-----------------------------------------------------------+
| C        | The process ID of the client application.                 |
| lientPID |                                                           |
+----------+-----------------------------------------------------------+
| Conn     | The connection ID of the primary Server. Used when        |
| ectionID | connecting to an \"Always Up\" backup server.             |
+----------+-----------------------------------------------------------+
| Opti     | -   Represented in [least significant bit                 |
| onFlags1 |     order](#Section_bbc22f15e1a04338a169c79819d39b1c).    |
|          |                                                           |
|          | -   fByteOrder: The byte order used by client for numeric |
|          |     and datetime data types.                              |
|          |                                                           |
|          |     -   0 = ORDER_X86                                     |
|          |                                                           |
|          |     -   1 = ORDER_68000[\<18\>](\l)                       |
|          |                                                           |
|          | -   fChar: The character set used on the client.          |
|          |                                                           |
|          |     -   0 = CHARSET_ASCII                                 |
|          |                                                           |
|          |     -   1 = CHARSET_EBCDIC                                |
|          |                                                           |
|          | -   fFloat: The type of floating point representation     |
|          |     used by the client.[\<19\>](\l)                       |
|          |                                                           |
|          |     -   0 = FLOAT_IEEE_754                                |
|          |                                                           |
|          |     -   1 = FLOAT_VAX                                     |
|          |                                                           |
|          |     -   2 = ND5000                                        |
|          |                                                           |
|          | -   fDumpLoad: Set is dump/load or BCP capabilities are   |
|          |     needed by the client.                                 |
|          |                                                           |
|          |     -   0 = DUMPLOAD_ON                                   |
|          |                                                           |
|          |     -   1 = DUMPLOAD_OFF                                  |
|          |                                                           |
|          | -   fUseDB: Set if the client requires warning messages   |
|          |     on execution of the USE SQL statement. If this flag   |
|          |     is not set, the server MUST NOT inform the client     |
|          |     when the database changes, and therefore the client   |
|          |     is unaware of any accompanying collation changes.     |
|          |                                                           |
|          |     -   0 = USE_DB_OFF                                    |
|          |                                                           |
|          |     -   1 = USE_DB_ON                                     |
|          |                                                           |
|          | -   fDatabase: Set if the change to initial database      |
|          |     needs to succeed if the connection is to succeed.     |
|          |                                                           |
|          |     -   0 = INIT_DB_WARN                                  |
|          |                                                           |
|          |     -   1 = INIT_DB_FATAL                                 |
|          |                                                           |
|          | -   fSetLang: Set if the client requires warning messages |
|          |     on execution of a language change statement.          |
|          |                                                           |
|          |     -   0 = SET_LANG_OFF                                  |
|          |                                                           |
|          |     -   1 = SET_LANG_ON                                   |
+----------+-----------------------------------------------------------+
| Opti     | -   Represented in least significant bit order.           |
| onFlags2 |                                                           |
|          | -   fLanguage: Set if the change to initial language      |
|          |     needs to succeed if the connect is to succeed.        |
|          |                                                           |
|          |     -   0 = INIT_LANG_WARN                                |
|          |                                                           |
|          |     -   1 = INIT_LANG_FATAL                               |
|          |                                                           |
|          | -   fODBC: Set if the client is the ODBC driver. This     |
|          |     causes the server to set ANSI_DEFAULTS to ON,         |
|          |     CURSOR_CLOSE_ON_COMMIT and IMPLICIT_TRANSACTIONS to   |
|          |     OFF, TEXTSIZE to 0x7FFFFFFF (2GB) (TDS 7.2 and        |
|          |     earlier), TEXTSIZE to infinite (introduced in TDS     |
|          |     7.3), and ROWCOUNT to infinite.[\<20\>](\l)           |
|          |                                                           |
|          |     -   0 = ODBC_OFF                                      |
|          |                                                           |
|          |     -   1 = ODBC_ON                                       |
|          |                                                           |
|          | -   fTranBoundary                                         |
|          |                                                           |
|          | -   fCacheConnect                                         |
|          |                                                           |
|          | -   fUserType: The type of user connecting to the server. |
|          |                                                           |
|          |     -   0 = USER_NORMAL---regular logins                  |
|          |                                                           |
|          |     -   1 = USER_SERVER---reserved                        |
|          |                                                           |
|          |     -   2 = USER_REMUSER---Distributed Query login        |
|          |                                                           |
|          |     -   3 = USER_SQLREPL---replication login              |
|          |                                                           |
|          | -   fIntSecurity: The type of security required by the    |
|          |     client.                                               |
|          |                                                           |
|          |     -   0 = INTEGRATED_SECURTY_OFF                        |
|          |                                                           |
|          |     -   1 = INTEGRATED_SECURITY_ON                        |
+----------+-----------------------------------------------------------+
| T        | -   Represented in least significant bit order.           |
| ypeFlags |                                                           |
|          | -   fSQLType: The type of SQL the client sends to the     |
|          |     server.                                               |
|          |                                                           |
|          |     -   0 = SQL_DFLT                                      |
|          |                                                           |
|          |     -   1 = SQL_TSQL                                      |
|          |                                                           |
|          | -   fOLEDB: Set if the client is the OLEDB driver. This   |
|          |     causes the server to set ANSI_DEFAULTS to ON,         |
|          |     CURSOR_CLOSE_ON_COMMIT and IMPLICIT_TRANSACTIONS to   |
|          |     OFF, TEXTSIZE to 0x7FFFFFFF (2GB) (TDS 7.2 and        |
|          |     earlier), TEXTSIZE to infinite (introduced in TDS     |
|          |     7.3), and ROWCOUNT to infinite.[\<21\>](\l)           |
|          |                                                           |
|          |     -   0 = OLEDB_OFF                                     |
|          |                                                           |
|          |     -   1 = OLEDB_ON                                      |
|          |                                                           |
|          | -   fReadOnlyIntent: This bit was introduced in TDS 7.4;  |
|          |     however, TDS 7.1, 7.2, and 7.3 clients can also use   |
|          |     this bit in LOGIN7 to specify that the application    |
|          |     intent of the connection is read-only. The server     |
|          |     SHOULD ignore this bit if the highest TDS version     |
|          |     supported by the server is lower than TDS 7.4.        |
+----------+-----------------------------------------------------------+
| Opti     | -   Represented in least significant bit order.           |
| onFlags3 |                                                           |
|          | -   fChangePassword: Specifies whether the login request  |
|          |     SHOULD change password.                               |
|          |                                                           |
|          |     -   0 = No change request. ibChangePassword MUST be   |
|          |         0.                                                |
|          |                                                           |
|          |     -   1 = Request to change login\'s password.          |
|          |                                                           |
|          | -   fSendYukonBinaryXML: 1 if XML data type instances are |
|          |     returned as binary XML.[\<22\>](\l)                   |
|          |                                                           |
|          | -   fUserInstance: 1 if client is requesting separate     |
|          |     process to be spawned as user instance.               |
|          |                                                           |
|          | -   fUnknownCollationHandling: This bit is used by the    |
|          |     server to determine if a client is able to properly   |
|          |     handle collations introduced after TDS 7.2. TDS 7.2   |
|          |     and earlier clients are encouraged to use this login  |
|          |     packet bit. Servers MUST ignore this bit when it is   |
|          |     sent by TDS 7.3 and later clients. See                |
|          |     [\[MSDN-SQLCol                                        |
|          | lation\]](https://go.microsoft.com/fwlink/?LinkId=119987) |
|          |     and                                                   |
|          |     [\[MS-LCID\]](%5                                      |
|          | bMS-LCID%5d.pdf#Section_70feba9f294e491eb6eb56532684c37f) |
|          |     for the complete list of collations for a database    |
|          |     server that supports SQL and LCIDs.                   |
|          |                                                           |
|          |     -   0 = The server MUST restrict the collations sent  |
|          |         to a specific set of collations. It MAY           |
|          |         disconnect or send an error if some other value   |
|          |         is outside the specific collation set. The client |
|          |         MUST properly support all collations within the   |
|          |         collation set.                                    |
|          |                                                           |
|          |     -   1 = The server MAY send any collation that fits   |
|          |         in the storage space. The client MUST be able to  |
|          |         both properly support collations and gracefully   |
|          |         fail for those it does not support.               |
|          |                                                           |
|          | -   fExtension: Specifies whether ibExtension/cbExtension |
|          |     fields are used.                                      |
|          |                                                           |
|          |     -   0 = ibExtension/cbExtension fields are not used.  |
|          |         The fields are treated the same as                |
|          |         ibUnused/cchUnused.                               |
|          |                                                           |
|          |     -   1 = ibExtension/cbExtension fields are used.      |
+----------+-----------------------------------------------------------+
| Client   | This field is not used and can be set to zero.            |
| TimeZone |                                                           |
+----------+-----------------------------------------------------------+
| Cl       | The language code identifier (LCID) value for the client  |
| ientLCID | collation. If ClientLCID is specified, the specified      |
|          | collation is set as the session collation. Note that the  |
|          | total ClientLCID is 4 bytes, which implies that there is  |
|          | no support for SQL Sort orders.                           |
+----------+-----------------------------------------------------------+
| Offs     | The variable portion of this message. A stream of bytes   |
| etLength | in the order shown, indicates the offset (from the start  |
|          | of the message) and length of various parameters:         |
|          |                                                           |
|          | -   ibHostname & cchHostName: The client machine name.    |
|          |                                                           |
|          | -   ibUserName & cchUserName: The client user ID.         |
|          |                                                           |
|          | -   ibPassword & cchPassword: The password supplied by    |
|          |     the client.                                           |
|          |                                                           |
|          | -   ibAppName & cchAppName: The client application name.  |
|          |                                                           |
|          | -   ibServerName & cchServerName: The server name.        |
|          |                                                           |
|          | -   ibUnused & cbUnused: These parameters were reserved   |
|          |     until TDS 7.4.                                        |
|          |                                                           |
|          | -   ibExtension & cbExtension: This points to an          |
|          |     extension block. Introduced in TDS 7.4 when           |
|          |     fExtension is 1. The content pointed by ibExtension   |
|          |     is defined as follows:                                |
|          |                                                           |
|          | 627. ibFeatureExtLong = DWORD                             |
|          |                                                           |
|          |      Extension = ibFeatureExtLong                         |
|          |                                                           |
|          | ibFeatureExtLong provides the offset (from the start of   |
|          | the message) of FeatureExt block. ibFeatureExtLong MUST   |
|          | be 0 if FeatureExt block does not exist.                  |
|          |                                                           |
|          | Extension block can be extended in future. The client     |
|          | MUST NOT send more data than needed. The server SHOULD    |
|          | ignore any appended data that is unknown to the server.   |
|          |                                                           |
|          | -   ibCltIntName & cchCltIntName: The interface library   |
|          |     name (ODBC or OLEDB).                                 |
|          |                                                           |
|          | -   ibLanguage & cchLanguage: The initial language        |
|          |     (overrides the user ID\'s default language).          |
|          |                                                           |
|          | -   ibDatabase & cchDatabase: The initial database        |
|          |     (overrides the user ID\'s default database).          |
|          |                                                           |
|          | -   ClientID: The unique client ID (created by using the  |
|          |     NIC address). ClientID is the MAC address of the      |
|          |     physical network layer. It is used to identify the    |
|          |     client that is connecting to the server. This value   |
|          |     is mainly informational, and no processing steps on   |
|          |     the server side use it.                               |
|          |                                                           |
|          | -   ibSSPI & cbSSPI: SSPI data.                           |
|          |                                                           |
|          | If cbSSPI \< USHORT_MAX, then this length MUST be used    |
|          | for SSPI and cbSSPILong MUST be ignored.                  |
|          |                                                           |
|          | If cbSSPI == USHORT_MAX, then cbSSPILong MUST be checked. |
|          |                                                           |
|          | If cbSSPILong \> 0, then that value MUST be used. If      |
|          | cbSSPILong ==0, then cbSSPI (USHORT_MAX) MUST be used.    |
|          |                                                           |
|          | -   ibAtchDBFile & cchAtchDBFile: The file name for a     |
|          |     database that is to be attached during the connection |
|          |     process.                                              |
|          |                                                           |
|          | -   ibChangePassword & cchChangePassword: New password    |
|          |     for the specified login. Introduced in TDS 7.2.       |
|          |                                                           |
|          | -   cbSSPILong: Used for large SSPI data when             |
|          |     cbSSPI==USHORT_MAX.\                                  |
|          |     Introduced in TDS 7.2.                                |
+----------+-----------------------------------------------------------+
| Data     | The actual variable-length data portion referred to by    |
|          | OffsetLength.                                             |
+----------+-----------------------------------------------------------+
| F        | The unique identifier number of a feature. The available  |
| eatureId | features are described in the following table.            |
|          |                                                           |
|          | Introduced in TDS 7.4.                                    |
+----------+-----------------------------------------------------------+
| Featur   | The length, in bytes, of FeatureData for the              |
| eDataLen | corresponding FeatureId.                                  |
|          |                                                           |
|          | Introduced in TDS 7.4.                                    |
+----------+-----------------------------------------------------------+
| Fea      | Data of the feature. Each feature defines its own data    |
| tureData | format.                                                   |
|          |                                                           |
|          | The data for existing features are defined in the         |
|          | following table.                                          |
|          |                                                           |
|          | Introduced in TDS 7.4.                                    |
+----------+-----------------------------------------------------------+
| Fe       | The data block that can be used to inform and/or          |
| atureExt | negotiate features between client and server. It contains |
|          | data for one or more optional features. Each feature is   |
|          | assigned an identifier, followed by data length and data. |
|          | The data for each feature is defined by the feature's own |
|          | logic. If the server does not support the specific        |
|          | feature, it MUST skip the feature data and jump to next   |
|          | feature. If needed, each feature SHOULD have its own      |
|          | logic to detect whether the server accepts the feature    |
|          | option.                                                   |
|          |                                                           |
|          | Optionally, a feature can use a FEATUREEXTACK token       |
|          | (section                                                  |
|          | [2.2.7.11](#Section_2eb82f8e11f046dcb42d27302fa4701a)) to |
|          | acknowledge the feature along with LOGINACK. The detailed |
|          | acknowledge data SHOULD be defined by the feature itself. |
|          |                                                           |
|          | Introduced in TDS 7.4.                                    |
+----------+-----------------------------------------------------------+

The following table defines the options that are available in
FeatureExt.

+------------------------+---------------------------------------------+
| FeatureId              | FeatureData Description                     |
+========================+=============================================+
| %0x01                  | Session Recovery feature. This feature is   |
|                        | used to recover the session state of a      |
| (SESSIONRECOVERY)      | previous connection. Content is defined as  |
|                        | follows:                                    |
| (introduced in TDS     |                                             |
| 7.4)                   | 629. Length = DWORD                         |
|                        |                                             |
|                        |      RecoveryDatabase = B_VARCHAR           |
|                        |                                             |
|                        |      RecoveryCollation = BYTELEN            |
|                        |      \[COLLATION\]                          |
|                        |                                             |
|                        |      RecoveryLanguage = B_VARCHAR           |
|                        |                                             |
|                        |      SessionRecoveryData = Length           |
|                        |                                             |
|                        |      RecoveryDatabase                       |
|                        |                                             |
|                        |      RecoveryCollation                      |
|                        |                                             |
|                        |      RecoveryLanguage                       |
|                        |                                             |
|                        |      SessionStateDataSet                    |
|                        |                                             |
|                        |      InitSessionRecoveryData =              |
|                        |      SessionRecoveryData                    |
|                        |                                             |
|                        |      SessionRecoveryDataToBe =              |
|                        |      SessionRecoveryData                    |
|                        |                                             |
|                        |      FeatureData =                          |
|                        |      \[InitSessionRecoveryData              |
|                        |      SessionRecoveryDataToBe\]              |
|                        |                                             |
|                        | The Length field is the length, in bytes,   |
|                        | of SessionRecoveryData excluding the Length |
|                        | field itself. SessionStateDataSet is        |
|                        | described in section                        |
|                        | [2.2.7.21](                                 |
|                        | #Section_626fbe19f3564599ba17c70f44005106). |
|                        | The length of SessionStateDataSet can be    |
|                        | derived from the Length field and the       |
|                        | length of RecoveryDatabase,                 |
|                        | RecoveryCollation, and RecoveryLanguage.    |
|                        | The maximum length for RecoveryDatabase and |
|                        | RecoveryLanguage is 128                     |
|                        | [**Unicode**                                |
|                        | ](#gt_c305d0ab-8b94-461a-bd76-13b40cb8c4d8) |
|                        | characters.                                 |
|                        |                                             |
|                        | There are two sets of SessionRecoveryData.  |
|                        | The data for the first set,                 |
|                        | InitSessionRecoveryData, SHOULD come from   |
|                        | the initial login response data of the      |
|                        | initial connection to be recovered,         |
|                        | specifically, the                           |
|                        | Database/Collation/Language ENVCHANGE data  |
|                        | and SessionStateDataSet in FeatureExtAck.   |
|                        |                                             |
|                        | Data for the second set,                    |
|                        | SessionRecoveryDataToBe, SHOULD come from   |
|                        | the latest ENVCHANGE for                    |
|                        | Database/Collation/Language from the        |
|                        | connection to be recovered and the latest   |
|                        | data for each StateId in SessionStateData   |
|                        | from the connection to be recovered. If     |
|                        | login succeeded on this recovery            |
|                        | connection, the session state of the        |
|                        | connection MUST be set to                   |
|                        | SessionRecoveryDataToBe. To save space, if  |
|                        | data for                                    |
|                        | Recovery                                    |
|                        | Database/RecoveryCollation/RecoveryLanguage |
|                        | in SessionRecoveryDataToBe is the same as   |
|                        | data in InitSessionRecoveryData, the length |
|                        | value of each field SHOULD be 0. If data    |
|                        | for any session StateId is unchanged from   |
|                        | InitSessionRecoveryData, the corresponding  |
|                        | StateId data SHOULD be skipped in           |
|                        | SessionRecoveryDataToBe.                    |
|                        |                                             |
|                        | When this feature option is received and    |
|                        | the server supports connection recovery, a  |
|                        | FEATUREEXTACK token that contains data for  |
|                        | SESSIONRECOVERY feature MUST be returned    |
|                        | along with LOGINACK in the login response   |
|                        | to indicate that the server supports the    |
|                        | feature. If SESSIONRECOVERY is not          |
|                        | acknowledged in the login response, the     |
|                        | server does not support the feature and the |
|                        | client MUST disable the feature for this    |
|                        | connection.                                 |
|                        |                                             |
|                        | The client can request this feature option  |
|                        | with zero FeatureDataLen. This is used      |
|                        | during login for the initial connection to  |
|                        | indicate that the client prefers this       |
|                        | feature.                                    |
|                        |                                             |
|                        | When the client sends this feature option   |
|                        | with non-zero FeatureDataLen during login,  |
|                        | the option data SHOULD come from a previous |
|                        | connection. The TDS version in the login    |
|                        | request MUST be the same as the TDS version |
|                        | negotiated for the connection to be         |
|                        | recovered. The server MUST return the same  |
|                        | TDS version in the login response, and if   |
|                        | not, the client MUST disconnect the         |
|                        | connection and raise an error to the upper  |
|                        | layer.                                      |
|                        |                                             |
|                        | If a login record with non-zero             |
|                        | FeatureDataLen of this feature is received  |
|                        | and the server supports this feature, the   |
|                        | server MUST:                                |
|                        |                                             |
|                        | -   Force TDS version negotiation to use    |
|                        |     the TDS version requested by the        |
|                        |     client, and fail the login if the       |
|                        |     requested TDS version is not known to   |
|                        |     the server, for example, a TDS version  |
|                        |     that is later than the highest one on   |
|                        |     the server.                             |
|                        |                                             |
|                        | -   Validate the content in                 |
|                        |     SessionRecoveryData, and fail the login |
|                        |     if any data is invalid or any unknown   |
|                        |     session state exists.                   |
|                        |                                             |
|                        | After the feature is negotiated to be       |
|                        | enabled, the server SHOULD send session     |
|                        | state updates to the client via a           |
|                        | SESSIONSTATE token during the lifetime of   |
|                        | the connection. The client MUST track the   |
|                        | initial session state data and the latest   |
|                        | session state data. Session state data is   |
|                        | updated via a SESSIONSTATE token            |
|                        | incrementally.                              |
|                        |                                             |
|                        | When a client requests                      |
|                        | RESETCONNECTION/RESETCONNECTIONSKIPTRAN and |
|                        | the server acknowledges the request, both   |
|                        | client and server MUST update the baseline  |
|                        | of the session state data to be the same as |
|                        | the initial state as defined by             |
|                        | InitSessionRecoveryData, and any further    |
|                        | state update SHOULD be on top of the        |
|                        | initial state.                              |
|                        |                                             |
|                        | Session state data can be used to recover a |
|                        | dead connection as defined by               |
|                        | SessionRecoveryData. The client SHOULD try  |
|                        | to recover a dead connection if the latest  |
|                        | fRecovery bit is TRUE for all StateId that  |
|                        | were received from the server. The client   |
|                        | MUST NOT try to recover a dead connection   |
|                        | if the any latest fRecovery bit is FALSE.   |
+------------------------+---------------------------------------------+
| %0x02                  | The presence of the FEDAUTH FeatureExt      |
|                        | indicates that the client is authenticating |
| (FEDAUTH)[\<23\>](\l)  | by [**federated                             |
|                        | authentication**]                           |
| (introduced in TDS     | (#gt_5ae22a0e-5ff4-441b-80d4-224ef4dd4d19). |
| 7.4)                   | If the FEDAUTH FeatureId is present, the    |
|                        | value of fIntSecurity MUST be 0. The format |
|                        | of the data is as described below based on  |
|                        | the bFedAuthLibrary that is used.           |
|                        |                                             |
|                        | bFedAuthLibrary = 0x7F is a reserved value. |
|                        |                                             |
|                        | When the bFedAuthLibrary is Live ID Compact |
|                        | Token, the format is as follows:            |
|                        |                                             |
|                        | 645. bFedAuthLibrary = 7BIT                 |
|                        |                                             |
|                        |      fFedAuthEcho = BIT                     |
|                        |                                             |
|                        |      Options = bFedAuthLibrary              |
|                        |                                             |
|                        |      fFedAuthEcho                           |
|                        |                                             |
|                        |      FedAuthToken = L_VARBYTE               |
|                        |                                             |
|                        |      Nonce = 32BYTE                         |
|                        |                                             |
|                        |      ChannelBindingToken = BYTESTREAM       |
|                        |                                             |
|                        |      Signature = 32BYTE                     |
|                        |                                             |
|                        |      SignedData = Nonce                     |
|                        |                                             |
|                        |      \[ChannelBindingToken\]                |
|                        |                                             |
|                        |      Signature                              |
|                        |                                             |
|                        |      FeatureData = Options                  |
|                        |                                             |
|                        |      FedAuthToken                           |
|                        |                                             |
|                        |      SignedData                             |
|                        |                                             |
|                        | bFedAuthLibrary: 7 bits, collectively       |
|                        | treated as a 7-bit unsigned integer,        |
|                        | indicating the library that is used by the  |
|                        | client for federated authentication.        |
|                        |                                             |
|                        | 0x00 = Live ID Compact Token. The format of |
|                        | the Live ID Compact Token and the way in    |
|                        | which the Live ID Compact Token is obtained |
|                        | are out of the scope of this document.      |
|                        |                                             |
|                        | fFedAuthEcho: The intention of this flag is |
|                        | for the client to echo the server's         |
|                        | FEDAUTHREQUIRED prelogin option, so that    |
|                        | the server can validate that the response   |
|                        | was not tampered with. The client MUST      |
|                        | assign this flag to 1 if and only if the    |
|                        | server's PRELOGIN response contained a      |
|                        | FEDAUTHREQUIRED option with a               |
|                        | B_FEDAUTHREQUIRED value of 0x01.            |
|                        |                                             |
|                        | FedAuthToken: The binary authentication     |
|                        | token generated by the specified federated  |
|                        | authentication library. The length of       |
|                        | FedAuthToken MUST NOT be 0.                 |
|                        |                                             |
|                        | Nonce: The nonce provided by the server     |
|                        | during the pre-login exchange, echoed back  |
|                        | to the server by the client.                |
|                        |                                             |
|                        | ChannelBindingToken: This optional field    |
|                        | MAY be omitted, but if encryption is being  |
|                        | used for the lifetime of the TDS connection |
|                        | and the client is able to generate a        |
|                        | channel binding token, the field SHOULD be  |
|                        | included in the payload. When present,      |
|                        | ChannelBindingToken contains the channel    |
|                        | binding token associated with the           |
|                        | underlying SSL stream.                      |
|                        |                                             |
|                        | Signature: The HMAC-SHA-256                 |
|                        | [\[RFC6234\]](http                          |
|                        | s://go.microsoft.com/fwlink/?LinkId=328921) |
|                        | hash of the server-specified nonce and, if  |
|                        | it is present in the FeatureData, the       |
|                        | ChannelBindingToken, is generated by using  |
|                        | the session key retrieved from the          |
|                        | federated authentication context as the     |
|                        | shared secret.                              |
|                        |                                             |
|                        | The length of the ChannelBindingToken field |
|                        | is not explicitly conveyed in the protocol  |
|                        | but can be determined by comparing the      |
|                        | FeatureDataLen against the length of the    |
|                        | remainder of the feature data, which is     |
|                        | explicitly transmitted in the protocol.     |
|                        |                                             |
|                        | When bFedAuthLibrary is Security Token, the |
|                        | format is as follows:                       |
|                        |                                             |
|                        | 663. bFedAuthLibrary = 7BIT                 |
|                        |                                             |
|                        |      fFedAuthEcho = BIT                     |
|                        |                                             |
|                        |      Options = bFedAuthLibrary              |
|                        |                                             |
|                        |      fFedAuthEcho                           |
|                        |                                             |
|                        |      FedAuthToken = L_VARBYTE               |
|                        |                                             |
|                        |      Nonce = 32BYTE                         |
|                        |                                             |
|                        |      OtherData = Nonce                      |
|                        |                                             |
|                        |      FeatureData = Options                  |
|                        |                                             |
|                        |      FedAuthToken                           |
|                        |                                             |
|                        |      \[OtherData\]                          |
|                        |                                             |
|                        | bFedAuthLibrary: 7 bits, collectively       |
|                        | treated as a 7-bit unsigned integer,        |
|                        | indicating the library that is used by the  |
|                        | client for federated authentication.        |
|                        |                                             |
|                        | 0x01 = Security Token. The format of the    |
|                        | token and the way in which this token is    |
|                        | obtained are out of the scope of this       |
|                        | document.                                   |
|                        |                                             |
|                        | fFedAuthEcho: The intention of this flag is |
|                        | for the client to echo the server's         |
|                        | FEDAUTHREQUIRED prelogin option, so that    |
|                        | the server can validate that the response   |
|                        | was not tampered with. The client MUST      |
|                        | assign this flag to 1 if and only if the    |
|                        | server's PRELOGIN response contained a      |
|                        | FEDAUTHREQUIRED option with a               |
|                        | B_FEDAUTHREQUIRED value of 0x01.            |
|                        |                                             |
|                        | FedAuthToken: The binary authentication     |
|                        | token generated by the specified federated  |
|                        | authentication library. The length of       |
|                        | FedAuthToken MUST NOT be 0.                 |
|                        |                                             |
|                        | Nonce: The nonce provided by the server     |
|                        | during the Prelogin exchange and echoed     |
|                        | back to the server by the client. This      |
|                        | field MUST be present if the server's       |
|                        | PRELOGIN message included a NONCE field.    |
|                        | Otherwise, this field MUST NOT be present.  |
|                        |                                             |
|                        | When bFedAuthLibrary is [**Azure Active     |
|                        | Directory Authentication Library            |
|                        | (ADAL)**                                    |
|                        | ](#gt_5a728127-a59d-4cf9-8ab5-4a4e0747cc51) |
|                        | \[that is, 0x02\], the format is as         |
|                        | follows:                                    |
|                        |                                             |
|                        | 677. bFedAuthLibrary = 7BIT                 |
|                        |                                             |
|                        |      fFedAuthEcho = BIT                     |
|                        |                                             |
|                        |      Workflow = BYTE                        |
|                        |                                             |
|                        |      Options = bFedAuthLibrary              |
|                        |                                             |
|                        |      fFedAuthEcho                           |
|                        |                                             |
|                        |      Workflow                               |
|                        |                                             |
|                        | bFedAuthLibrary: 7 bits, collectively       |
|                        | treated as a 7-bit unsigned integer that    |
|                        | indicates the library that is used by the   |
|                        | client for federated authentication.        |
|                        |                                             |
|                        | 0x02 = ADAL. After the client establishes   |
|                        | the intent to use ADAL, for which           |
|                        | additional information is required by the   |
|                        | client to generate a token, the server MUST |
|                        | respond with the Federated Authentication   |
|                        | Information token to the client with        |
|                        | \"FedAuthInfoIDs: STSURL, SPN\".            |
|                        |                                             |
|                        | fFedAuthEcho: The intention of this flag is |
|                        | for the client to echo the server's         |
|                        | FEDAUTHREQUIRED pre-login option so that    |
|                        | the server can validate that the response   |
|                        | was not tampered with. The client MUST      |
|                        | assign this flag to 1 if and only if the    |
|                        | server's PRELOGIN Response contains a       |
|                        | FEDAUTHREQUIRED option with a               |
|                        | B_FEDAUTHREQUIRED value of 0x01.            |
|                        |                                             |
|                        | Workflow: Indicates the ADAL (that is,      |
|                        | 0x02) workflow that is being used.          |
|                        |                                             |
|                        | 0x01 = Username/password. A username and    |
|                        | password are passed to ADAL to retrieve a   |
|                        | token.                                      |
|                        |                                             |
|                        | 0x02 = Integrated. A Windows identity is    |
|                        | passed to ADAL to retrieve a token.         |
|                        |                                             |
|                        | All other values of bFedAuthLibrary are     |
|                        | reserved.                                   |
+------------------------+---------------------------------------------+
| %0x04                  | The presence of the COLUMNENCRYPTION        |
|                        | FeatureExt indicates that the client        |
| (COLUMNENCRYPTION)     | SHOULD[\<24\>](\l) be capable of performing |
|                        | cryptographic operations on data. The       |
| (introduced in TDS     | feature data are described as follows:      |
| 7.4)                   |                                             |
|                        | 683. COLUMNENCRYPTION_VERSION = BYTE        |
|                        |                                             |
|                        |      FeatureData = COLUMNENCRYPTION_VERSION |
|                        |                                             |
|                        | COLUMNENCRYPTION_VERSION: This field        |
|                        | describes the cryptographic protocol        |
|                        | version that the client understands. The    |
|                        | values of this field are as follows:        |
|                        |                                             |
|                        | -   1 = The client supports column          |
|                        |     encryption without [**enclave           |
|                        |     computations**]                         |
|                        | (#gt_6fe5534f-5cd8-4ab6-aba4-637a4344eda0). |
|                        |                                             |
|                        | -   2 = The client SHOULD[\<25\>](\l)       |
|                        |     support column encryption when          |
|                        |     encrypted data require enclave          |
|                        |     computations.                           |
|                        |                                             |
|                        | -   3 = The client SHOULD[\<26\>](\l)       |
|                        |     support column encryption when          |
|                        |     encrypted data require enclave          |
|                        |     computations with the additional        |
|                        |     ability to cache column encryption keys |
|                        |     that are to be sent to the enclave and  |
|                        |     the ability to retry queries when the   |
|                        |     keys sent by the client do not match    |
|                        |     what is needed for the query to run.    |
+------------------------+---------------------------------------------+
| %0x05                  | The presence of the GLOBALTRANSACTIONS      |
|                        | FeatureExt indicates that the client is     |
| (GLOBALTRA             | capable of performing [**Global             |
| NSACTIONS)[\<27\>](\l) | Transactions**]                             |
|                        | (#gt_57552b13-b14e-4601-9621-500ce3297d15). |
| (introduced in TDS     | The feature data is described as follows:   |
| 7.4)                   |                                             |
|                        | 686. FeatureData = NO DATA                  |
|                        |                                             |
|                        | NO DATA: No feature data is sent with the   |
|                        | GLOBALTRANSACTIONS FeatureExt.              |
+------------------------+---------------------------------------------+
| %0x08                  | The presence of the AZURESQLSUPPORT         |
|                        | FeatureExt indicates whether the client     |
| (AZURESQLSUPPORT)      | MAY[\<28\>](\l) support failover partner    |
|                        | login with read-only intent in Azure SQL    |
| (introduced in TDS     | Database. For information about failover    |
| 7.4)                   | partner, see                                |
|                        | [\[MSDOCS-DBMirror\]](https                 |
|                        | ://go.microsoft.com/fwlink/?linkid=874052). |
|                        |                                             |
|                        | The feature data is described as follows:   |
|                        |                                             |
|                        | 687. FeatureData = BYTE                     |
|                        |                                             |
|                        | BYTE: The Bit 0 flag specifies whether      |
|                        | failover partner login with read-only       |
|                        | intent is supported. The values of this     |
|                        | BYTE are as follows:                        |
|                        |                                             |
|                        | -   0 = The server does not support the     |
|                        |     AZURESQLSUPPORT feature extension.      |
|                        |                                             |
|                        | -   1 = The server supports the             |
|                        |     AZURESQLSUPPORT feature extension.      |
+------------------------+---------------------------------------------+
| %0x09                  | The DATACLASSIFICATION FeatureExt           |
|                        | SHOULD[\<29\>](\l) indicate that the client |
| (DATACLASSIFICATION)   | is capable of accepting [**data             |
|                        | classification**                            |
| (introduced in TDS     | ](#gt_acdeafb0-9b24-420e-b712-9284ad49eb56) |
| 7.4)                   | information about a query [**result         |
|                        | set**]                                      |
|                        | (#gt_c8a27238-8ccc-442b-9604-75f74d3e6b3d). |
|                        | The feature data is described as follows:   |
|                        |                                             |
|                        | 688. DATACLASSIFICATION_VERSION = BYTE      |
|                        |                                             |
|                        |      FeatureData =                          |
|                        |      DATACLASSIFICATION_VERSION             |
|                        |                                             |
|                        |      VersionSpecificData                    |
|                        |                                             |
|                        | DATACLASSIFICATION_VERSION: This field      |
|                        | specifies the maximum version number of the |
|                        | DATACLASSIFICATION token that the client    |
|                        | can support. This value MUST be one of the  |
|                        | following:                                  |
|                        |                                             |
|                        | -   1 = The server does not send            |
|                        |     sensitivity-rank data as part of the    |
|                        |     DATACLASSIFICATION token.               |
|                        |                                             |
|                        | -   2 = The server sends sensitivity-rank   |
|                        |     data as part of the DATACLASSIFICATION  |
|                        |     token.                                  |
|                        |                                             |
|                        | VersionSpecificData: This field specifies   |
|                        | the version-specific data that is required  |
|                        | for the DATACLASSIFICATION feature          |
|                        | extension request. The values of this field |
|                        | are as follows.                             |
|                        |                                             |
|                        | When the value of the                       |
|                        | DATACLASSIFICATION_VERSION field is 1 or 2, |
|                        | there is no version-specific data.          |
+------------------------+---------------------------------------------+
| %0x0A                  | The presence of the UTF8_SUPPORT FeatureExt |
|                        | indicates whether the client's ability to   |
| (UTF8_SUPPORT)         | send and receive UTF-8 encoded data         |
|                        | SHOULD[\<30\>](\l) be supported. The        |
| (introduced in TDS     | feature data is described as follows:       |
| 7.4)                   |                                             |
|                        | 692. FeatureData = BYTE                     |
|                        |                                             |
|                        | BYTE: The Bit 0 flag specifies whether the  |
|                        | client supports UTF-8 data. The values of   |
|                        | this BYTE are as follows:                   |
|                        |                                             |
|                        | -   0 = The client does not support UTF-8   |
|                        |     encoded data.                           |
|                        |                                             |
|                        | -   1 = The client supports UTF-8 encoded   |
|                        |     data.                                   |
|                        |                                             |
|                        | Failure of the client to receive an         |
|                        | acknowledgement of UTF-8 feature extension  |
|                        | support from the server indicates that the  |
|                        | server cannot send or receive UTF-8 encoded |
|                        | data.                                       |
+------------------------+---------------------------------------------+
| %0x0B                  | The presence of the AZURESQLDNSCACHING      |
|                        | FeatureExt indicates whether the client has |
| (AZURESQLD             | the ability to store the mapping between    |
| NSCACHING)[\<31\>](\l) | the TDS server endpoint's application       |
|                        | domain, identified by its fully qualified   |
| (introduced in TDS     | domain name (FQDN), and the equivalent IP   |
| 7.4)                   | address in the client's application cache.  |
|                        |                                             |
|                        | The feature data is described as follows:   |
|                        |                                             |
|                        | 693. FeatureData = NO DATA                  |
|                        |                                             |
|                        | NO DATA: No feature data is sent with the   |
|                        | AZURESQLDNSCACHING FeatureExt. The presence |
|                        | of this FeatureExt token indicates to the   |
|                        | server that the client can support the      |
|                        | feature.                                    |
+------------------------+---------------------------------------------+
| %0x0D (JSONSUPPORT)    | The presence of JSONSUPPORT FeatureExt      |
| (introduced in TDS     | indicates whether the capability of the     |
| 7.4)                   | client to send and receive JSON datatype    |
|                        | SHOULD[\<32\>](\l) be supported. The        |
|                        | feature data is described as follows:       |
|                        |                                             |
|                        | 694. JSONSUPPORT_VERSION = BYTE             |
|                        |                                             |
|                        |      FeatureData = JSONSUPPORT_VERSION      |
|                        |                                             |
|                        | JSONSUPPORT_VERSION: This field specifies   |
|                        | the version number of the json datatype     |
|                        | that is to be used for this connection.     |
|                        | This value is 1.                            |
+------------------------+---------------------------------------------+
| %0x0E (VECTORSUPPORT)  | The presence of the VECTORSUPPORT           |
| (introduced in TDS     | FeatureExt indicates whether the capability |
| 7.4)                   | of the client to send and receive the       |
|                        | VECTOR datatype SHOULD[\<33\>](\l) be       |
|                        | supported. The feature data is described as |
|                        | follows:                                    |
|                        |                                             |
|                        | 696. VECTORSUPPORT_VERSION = BYTE           |
|                        |                                             |
|                        |      FeatureData = VECTORSUPPORT_VERSION    |
|                        |                                             |
|                        | VECTORSUPPORT_VERSION: This field specifies |
|                        | the version number of the vector datatype   |
|                        | that is to be used for this connection.     |
|                        | This value is 1.                            |
+------------------------+---------------------------------------------+
| %0x0F                  | The presence of ENHANCEDROUTINGSUPPORT      |
| (ENHANCEDROUTI         | indicates whether the client has the        |
| NGSUPPORT)[\<34\>](\l) | capability to receive and act on the        |
| (introduced in TDS     | Enhanced Routing ENVCHANGE token.           |
| 7.4)                   |                                             |
|                        | The feature data is described as follows:   |
|                        |                                             |
|                        | 698. FeatureData = NO DATA                  |
|                        |                                             |
|                        | NO DATA: No feature data is sent with the   |
|                        | ENHANCEDROUTINGSUPPORT FeatureExt. The      |
|                        | presence of this FeatureExt token indicates |
|                        | to the server that the client can support   |
|                        | the feature.                                |
+------------------------+---------------------------------------------+
| %xFF                   | This option signals the end of the          |
|                        | FeatureExt feature and MUST be the          |
| (TERMINATOR)           | feature's last option.                      |
+------------------------+---------------------------------------------+

**Login Data Validation Rules**

cchHostName MUST specify at most 128 Unicode characters.

cchUserName MUST specify at most 128 Unicode characters.

cchPassword MUST specify at most 128 Unicode characters.

cchAppName MUST specify at most 128 Unicode characters.

cchServerName MUST specify at most 128 Unicode characters.

cbExtension MUST NOT exceed 255 bytes.

cchCltIntName MUST specify at most 128 Unicode characters.

cchLanguage MUST specify at most 128 Unicode characters.

cchDatabase MUST specify at most 128 Unicode characters.

cchAtchDBFile MUST specify at most 260 Unicode characters.

cchChangePassword MUST specify at most 128 Unicode characters.

The value at ibUserName---if specified---is semantically enclosed in
brackets (\[\]) and MUST conform to the rules for valid delimited object
identifiers. Login MUST fail otherwise.

The value at ibDatabase---if specified---is semantically enclosed in
brackets (\[\]) and MUST conform to the rules for valid delimited object
identifiers. Login MUST fail otherwise.

Before submitting a password from the client to the server, for every
byte in the password buffer starting with the position pointed to by
ibPassword or ibChangePassword, the client SHOULD first swap the four
high bits with the four low bits and then do a bit-XOR with 0xA5
(10100101). After reading a submitted password, for every byte in the
password buffer starting with the position pointed to by ibPassword or
ibChangePassword, the server SHOULD first do a bit-XOR with 0xA5
(10100101) and then swap the four high bits with the four low bits.

#### PRELOGIN

**Stream Name:**

699. PRELOGIN

**Stream Function:**

A message sent by the client to set up context for login. The server
responds to a client PRELOGIN message with a message of packet header
type 0x04 and the packet data containing a PRELOGIN structure.

In TDS 7.x, this message stream is also used to wrap the SSL handshake
payload, if encryption is needed. In this scenario, where the PRELOGIN
message is transporting the SSL handshake payload, the packet data is
simply the raw bytes of the SSL handshake payload.

**Stream Comments:**

-   Packet header type 0x12.

-   A sample PRELOGIN message is in section
    [4.1](#Section_9420b4a3eb9f4f5e90bd3160444aa5a7).

**Stream-Specific Rules:**

700. UL_VERSION = ULONG ; version of the sender

     US_SUBBUILD = USHORT ; sub-build number of the sender

     B_FENCRYPTION = BYTE

     B_INSTVALIDITY = \*BYTE %x00 ; name of the instance

     ; of the database server that supports SQL

     ; or just %x00

     UL_THREADID = ULONG ; client application thread id

     ; used for debugging purposes

     B_MARS = BYTE ; sender requests MARS support

     GUID_CONNID = 16BYTE ; client application trace id

     ; used for debugging purposes

     ; introduced in TDS 7.4

     GUID_ActivityID = 16BYTE ; client application activity id

     ; used for debugging purposes

     ; introduced in TDS 7.4

     ActivitySequence = ULONG ; client application activity sequence

     ; used for debugging purposes

     ; introduced in TDS 7.4

     ACTIVITYID = GUID_ActivityID ; client application activity id token

     ActivitySequence ; used for debugging purposes

     ; introduced in TDS 7.4

     B_FEDAUTHREQUIRED = BYTE ; authentication library requirement of
     the sender

     ; when using Integrated Authentication identity

     ; introduced in TDS 7.4

     NONCE = 32BYTE ; nonce to be encrypted by using session key from

     ; federated authentication handshake

     TERMINATOR = %xFF ; signals end of PRELOGIN message

     PL_OPTION_DATA = \*BYTE ; actual data for the option

     PL_OFFSET = USHORT ; big endian

     PL_OPTION_LENGTH = USHORT ; big endian

     PL_OPTION_TOKEN = BYTE ; token value representing the option

     PRELOGIN_OPTION = (PL_OPTION_TOKEN

     PL_OFFSET

     PL_OPTION_LENGTH)

     /

     TERMINATOR

     SSL_PAYLOAD = \*BYTE ; SSL handshake raw payload

**Stream Definition:**

743. PRELOGIN = (\*PRELOGIN_OPTION

     \*PL_OPTION_DATA)

     /

     SSL_PAYLOAD

PL_OPTION_TOKEN is described in the following table.

+----------------+----+-----------------------------------------------+
| P              | V  | Description                                   |
| L_OPTION_TOKEN | al |                                               |
|                | ue |                                               |
+================+====+===============================================+
| VERSION        | 0x | PL_OPTION_DATA = UL_VERSION                   |
|                | 00 |                                               |
|                |    | US_SUBBUILD                                   |
|                |    |                                               |
|                |    | UL_VERSION is composed of major version (1    |
|                |    | byte), minor version (1 byte), and build      |
|                |    | number (2 bytes). It is represented in        |
|                |    | network byte order                            |
|                |    | ([**big-endian**                              |
|                |    | ](#gt_6f6f9e8e-5966-4727-8527-7e02fb864e7e)). |
|                |    |                                               |
|                |    | On x86 platforms, UL_VERSION is prepared as   |
|                |    | follows:                                      |
|                |    |                                               |
|                |    | VER_SQL_BUILD = USHORT                        |
|                |    |                                               |
|                |    | US_BUILD = SwapBytes (VER_SQL_BUILD);         |
|                |    |                                               |
|                |    | VER_SQL_MINOR = USHORT                        |
|                |    |                                               |
|                |    | VER_SQL_MAJOR = USHORT                        |
|                |    |                                               |
|                |    | UL_VERSION = US_BUILD / VER_SQL_MINOR /       |
|                |    | VER_SQL_MAJOR                                 |
|                |    |                                               |
|                |    | SwapBytes is used to swap bytes. For example, |
|                |    | SwapBytes(0x106A)= 0x6A10.                    |
+----------------+----+-----------------------------------------------+
| ENCRYPTION     | 0x | PL_OPTION_DATA = B_FENCRYPTION                |
|                | 01 |                                               |
+----------------+----+-----------------------------------------------+
| INSTOPT        | 0x | PL_OPTION_DATA = B_INSTVALIDITY               |
|                | 02 |                                               |
+----------------+----+-----------------------------------------------+
| THREADID       | 0x | PL_OPTION_DATA = UL_THREADID                  |
|                | 03 |                                               |
|                |    | This value SHOULD be empty when being sent    |
|                |    | from the server to the client.                |
+----------------+----+-----------------------------------------------+
| MARS           | 0x | PL_OPTION_DATA = B_MARS                       |
|                | 04 |                                               |
|                |    | -   0x00 = Off                                |
|                |    |                                               |
|                |    | -   0x01 = On                                 |
+----------------+----+-----------------------------------------------+
| TRACEID        | 0x | PL_OPTION_DATA = GUID_CONNID ACTIVITYID       |
|                | 05 |                                               |
|                |    | Introduced in TDS 7.4.                        |
+----------------+----+-----------------------------------------------+
| FEDAUTHREQUIR  | 0x | PL_OPTION_DATA = B_FEDAUTHREQUIRED            |
| ED[\<35\>](\l) | 06 |                                               |
|                |    | Introduced in TDS 7.4.                        |
+----------------+----+-----------------------------------------------+
| NONCEOPT       | 0x | 747. PL_OPTION_DATA = NONCE                   |
|                | 07 |                                               |
|                |    | The client MUST send this option if it        |
|                |    | expects to be able to use federated           |
|                |    | authentication with Live ID Compact Token to  |
|                |    | authenticate to the server on this            |
|                |    | connection.                                   |
|                |    |                                               |
|                |    | If the server understands the NONCEOPT option |
|                |    | and the client sends the option, the server   |
|                |    | MUST respond with its own NONCEOPT.           |
+----------------+----+-----------------------------------------------+
| TERMINATOR     | 0x | Termination token.                            |
|                | FF |                                               |
+----------------+----+-----------------------------------------------+

**Notes**

-   PL_OPTION_TOKEN VERSION is a required token, and it MUST be the
    first token sent as part of PRELOGIN. If this is not the case, the
    connection is closed by the server.

-   TERMINATOR is a required token, and it MUST be the last token of
    PRELOGIN_OPTION. TERMINATOR does not include length and bits
    specifying offset.

-   In TDS 7.x, if encryption is agreed upon during pre-login, SSL
    negotiation between client and server happens immediately after the
    PRELOGIN packet. Then login proceeds. For more information, see
    section [3.3.5.1](#Section_8bfcbcd21baf47928fff86a63a9e90fa).

-   In TDS 7.x, a PRELOGIN message wrapping the SSL_PAYLOAD occurs only
    after the initial PRELOGIN message containing the PRELOGIN_OPTION
    and PL_OPTION_DATA information is sent.

**Encryption**

***Applies to only TDS 7.x***

In TDS 8.0, because the TLS session is already established, the
encryption value that is sent by the client is ignored.

During the Pre-Login handshake, the client and the server negotiate the
wire encryption to be used. The encryption option values are as follows.

+---------------+-----------+-----------------------------------------+
| Setting       | Value     | Description                             |
+===============+===========+=========================================+
| ENCRYPT_OFF   | 0x00      | Encryption is available but off.        |
+---------------+-----------+-----------------------------------------+
| ENCRYPT_ON    | 0x01      | Encryption is available and on.         |
+---------------+-----------+-----------------------------------------+
| EN            | 0x02      | Encryption is not available.            |
| CRYPT_NOT_SUP |           |                                         |
+---------------+-----------+-----------------------------------------+
| ENCRYPT_REQ   | 0x03      | Encryption is required.                 |
+---------------+-----------+-----------------------------------------+
| ENCRYPT_EXT   | 0x20      | This bit is reserved.[\<36\>](\l)       |
+---------------+-----------+-----------------------------------------+
| ENCRYP        | 0X80      | Certificate-based authentication is     |
| T_CLIENT_CERT | (ENC      | requested by the client. The client     |
|               | RYPT_OFF) | certificate SHOULD[\<37\>](\l) be used  |
|               |           | to authenticate the user in place of    |
|               | or        | username and password only in specific  |
|               |           | extensibility scenarios where a         |
|               | 0X81      | loopback connection from an external    |
|               | (EN       | script is requested.                    |
|               | CRYPT_ON) |                                         |
|               |           |                                         |
|               | or        |                                         |
|               |           |                                         |
|               | 0x83      |                                         |
|               | (ENC      |                                         |
|               | RYPT_REQ) |                                         |
+---------------+-----------+-----------------------------------------+

The client sends the server the value ENCRYPT_OFF, ENCRYPT_NOT_SUP, or
ENCRYPT_ON. The client can also request certificate-based authentication
by sending the value ENCRYPT_CLIENT_CERT with ENCRYPT_OFF, ENCRYPT_ON,
or ENCRYPT_REQ. The connection is terminated if the client sends
ENCRYPT_CLIENT_CERT with ENCRYPT_NOT_SUP.

Depending upon whether the server has encryption available and enabled,
the server responds with an ENCRYPTION value in the response according
to the following table.

  ---------------------------------------------------------------------------
  Value sent by client  Value returned by Value returned   Value returned by
                        server when       by server when   server when server
                        server is set to  server is set to is set to
                        ENCRYPT_OFF       ENCRYPT_ON       ENCRYPT_NOT_SUP
  --------------------- ----------------- ---------------- ------------------
  ENCRYPT_OFF           ENCRYPT_OFF       ENCRYPT_REQ      ENCRYPT_NOT_SUP

  ENCRYPT_ON            ENCRYPT_ON        ENCRYPT_ON       ENCRYPT_NOT_SUP
                                                           (connection
                                                           terminated)

  ENCRYPT_NOT_SUP       ENCRYPT_NOT_SUP   ENCRYPT_REQ      ENCRYPT_NOT_SUP
                                          (connection      
                                          terminated)      

  ENCRYPT_REQ           ENCRYPT_ON        ENCRYPT_ON       ENCRYPT_NOT_SUP
                                                           (connection
                                                           terminated)

  ENCRYPT_CLIENT_CERT   ENCRYPT_OFF       ENCRYPT_REQ      ENCRYPT_NOT_SUP
  \| ENCRYPT_OFF                                           (connection
                                                           terminated)

  ENCRYPT_CLIENT_CERT   ENCRYPT_ON        ENCRYPT_ON       ENCRYPT_NOT_SUP
  \| ENCRYPT_ON                                            (connection
                                                           terminated)

  ENCRYPT_CLIENT_CERT   ENCRYPT_REQ\      ENCRYPT_REQ      ENCRYPT_REQ
  \| ENCRYPT_NOT_SUP    (connection       (connection      (connection
                        terminated)       terminated)      terminated)

  ENCRYPT_CLIENT_CERT   ENCRYPT_ON        ENCRYPT_ON       ENCRYPT_NOT_SUP
  \| ENCRYPT_REQ                                           (connection
                                                           terminated)
  ---------------------------------------------------------------------------

Assuming that the client is capable of encryption, the server requires
the client to behave in the following manner.

  ----------------------------------------------------------------------------
  Client        Value returned Value         Value returned Value returned
                from server is returned from from server is from server is
                ENCRYPT_OFF    server is     ENCRYPT_REQ    ENCRYPT_NOT_SUP
                               ENCRYPT_ON                   
  ------------- -------------- ------------- -------------- ------------------
  ENCRYPT_OFF   Encrypt login  Encrypt       Encrypt entire No encryption
                packet only    entire        connection     
                               connection                   

  ENCRYPT_ON    Error          Encrypt       Encrypt entire Error (connection
                (connection    entire        connection     terminated)
                terminated)    connection                   
  ----------------------------------------------------------------------------

If client and server negotiate to enable encryption or if the client has
requested certificate-based authentication, an SSL handshake takes place
immediately after the initial PRELOGIN/table response message exchange.
If ENCRYPT_CLIENT_CERT is specified, the certificate is exchanged in
this handshake. The SSL payloads MUST be transported as data in TDS
packets with the message type set to 0x12 in the packet header. For
example:

748. 0x 12 01 00 4e 00 00 00 00// Packet Header

     0x 16 03 01 00 &// SSL payload

This applies to SSL traffic. The client sends the SSL handshake payloads
as data in a PRELOGIN message. For TDS versions earlier than TDS 7.2,
the server SHOULD send the SSL handshake payloads as data in a [**table
response**](#gt_71dd1dd2-c167-49a8-a5f5-6b0df5c8b48a) message (0x04).
For TDS 7.2, TDS 7.3, and TDS 7.4, the server SHOULD send the SSL
handshake payloads as data in a PRELOGIN message. Upon successful
completion of the SSL handshake, the client proceeds to send the LOGIN7
stream to the server to initiate authentication.

**Instance Name**

If available, the client SHOULD send the server the name of the instance
to which it is connecting as a NULL-terminated multi-byte character set
(MBCS) string in the INSTOPT option. If the string is empty or is
case-insensitively equal, by using the server\'s locale for comparison
to either the server\'s instance name or \"MSSQLServer\", the server
SHOULD\<38\> return an INSTOPT containing a byte with the value 0 to
indicate that the client\'s INSTOPT matches the server\'s instance.
Otherwise, the server SHOULD return an INSTOPT containing a byte with
the value of 1. The client SHOULD use the INSTOPT value from the
server\'s PRELOGIN response for verification purposes and SHOULD
terminate the connection if the INSTOPT option has the value 1.

**Authentication Requirement**

When the client wants to use either SSPI or federated authentication to
determine the authentication mechanism but does not necessarily have a
requirement as to which library to use, the client can use the
FEDAUTHREQUIRED option to negotiate whether the server has a requirement
for a given authentication mechanism. If the client\'s PRELOGIN request
message contains the FEDAUTHREQUIRED option, the client MUST specify
0x01 as the B_FEDAUTHREQUIRED value. If the server supports the
FEDAUTHREQUIRED option, the server MUST respond with a FEDAUTHREQUIRED
option that has either 0x00 or 0x01 as the B_FEDAUTHREQUIRED value. For
the choice between SSPI and federated authentication, a value of 0x00
indicates that the server does not require federated authentication as
the authentication mechanism, and a value of 0x01 indicates that the
server requires federated authentication as the authentication
mechanism. However, this mechanism is used only for capability
negotiation when choosing between SSPI and federated authentication and
does not necessarily bind the actual authentication mechanism that is
used.

#### RPC Request

**Stream Name:**

750. RPCRequest

**Stream Function:**

Request to execute an RPC.

**Stream Comments:**

-   Packet header type 0x03.

-   To execute an RPC on the server, the client sends an RPCRequest data
    stream to the server. This is a binary stream that contains the RPC
    Name (or ProcID), Options, and Parameters. Each RPC MUST be
    contained within a separate message and not mixed with other [**SQL
    statements**](#gt_dc5ca224-43ec-4b44-9dba-726d6fd6057d).

-   A sample RPCRequest message is in section
    [4.8](#Section_1469b2fa6cab42e991f9044d358b306b).

**Stream-Specific Rules:**

751. ProcID = USHORT

     ProcIDSwitch = %xFF %xFF

     ProcName = US_VARCHAR

     NameLenProcID = ProcName

     /

     (ProcIDSwitch ProcID)

     fWithRecomp = BIT

     fNoMetaData = BIT

     fReuseMetaData = BIT

     OptionFlags = fWithRecomp

     fNoMetaData

     fReuseMetaData

     13FRESERVEDBIT

     fByRefValue = BIT

     fDefaultValue = BIT

     fEncrypted = BIT

     StatusFlags = fByRefValue

     fDefaultValue

     1FRESERVEDBIT

     fEncrypted

     4FRESERVEDBIT

     ParamMetaData = B_VARCHAR

     StatusFlags

     (TYPE_INFO / TVP_TYPE_INFO) ; (TVP_TYPE_INFO introduced in TDS 7.3)

     ParamLenData = TYPE_VARBYTE

     EncryptionAlgo = BYTE ; (introduced in TDS 7.4)

     AlgoName = B_VARCHAR ; (introduced in TDS 7.4)

     EncryptionType = BYTE ; (introduced in TDS 7.4)

     NormVersion = BYTE ; (introduced in TDS 7.4)

     DatabaseId = ULONG ; (introduced in TDS 7.4)

     CekId = ULONG ; (introduced in TDS 7.4)

     CekVersion = ULONG ; (introduced in TDS 7.4)

     CekMDVersion = ULONGLONG ; (introduced in TDS 7.4)

     ParamCipherInfo = TYPE_INFO

     EncryptionAlgo

     \[AlgoName\]

     EncryptionType

     DatabaseId

     CekId

     CekVersion

     CekMDVersion

     NormVersion

     ParameterData = ParamMetaData

     ParamLenData

     \[ParamCipherInfo\]

     EnclavePackage = L_VARBYTE ; (introduced in TDS 7.4)

     BatchFlag = %x80 / %xFF ; (changed to %xFF in TDS 7.2)

     NoExecFlag = %xFE ; (introduced in TDS 7.2)

     RPCReqBatch = NameLenProcID

     OptionFlags

     \*EnclavePackage

     \*ParameterData

The length for the instance value of UDTs is specified as a ULONGLONG.
Also, ParameterData is repeated once for each parameter in the request.

A StatusFlags of fDefaultValue bit MUST be zero for TVP_TYPE_INFO.

The fByRefValue MUST be zero for TVP_TYPE_INFO.

**Stream Definition:**

818. RPCRequest = ALL_HEADERS

     RPCReqBatch

     \*((BatchFlag / NoExecFlag) RPCReqBatch)

     \[BatchFlag / NoExecFlag\]

Note that RPCReqBatch is repeated once for each RPC in the batch.

**Stream Parameter Details:**

+-----------+----------------------------------------------------------+
| Parameter | Description                                              |
+===========+==========================================================+
| ProcID    | The number identifying the special [**stored             |
|           | procedure**](#gt_324d32b3-f4f3-41c9-b695-78c498094fb7)   |
|           | to be executed. The valid numbers with associated        |
|           | special stored procedure are as follows:                 |
|           |                                                          |
|           | -   Sp_Cursor = 1                                        |
|           |                                                          |
|           | -   Sp_CursorOpen = 2                                    |
|           |                                                          |
|           | -   Sp_CursorPrepare = 3                                 |
|           |                                                          |
|           | -   Sp_CursorExecute = 4                                 |
|           |                                                          |
|           | -   Sp_CursorPrepExec = 5                                |
|           |                                                          |
|           | -   Sp_CursorUnprepare = 6                               |
|           |                                                          |
|           | -   Sp_CursorFetch = 7                                   |
|           |                                                          |
|           | -   Sp_CursorOption = 8                                  |
|           |                                                          |
|           | -   Sp_CursorClose = 9                                   |
|           |                                                          |
|           | -   Sp_ExecuteSql = 10                                   |
|           |                                                          |
|           | -   Sp_Prepare = 11                                      |
|           |                                                          |
|           | -   Sp_Execute = 12                                      |
|           |                                                          |
|           | -   Sp_PrepExec = 13                                     |
|           |                                                          |
|           | -   Sp_PrepExecRpc = 14                                  |
|           |                                                          |
|           | -   Sp_Unprepare = 15                                    |
+-----------+----------------------------------------------------------+
| Pro       | ProcIDSwitch can occur as part of NameLenProcID (see     |
| cIDSwitch | below).                                                  |
+-----------+----------------------------------------------------------+
| ProcName  | The procedure name length (within US_VARCHAR), which     |
|           | MUST be no more than 1046 bytes.                         |
+-----------+----------------------------------------------------------+
| Name      | If the first USHORT contains 0xFFFF the following USHORT |
| LenProcID | contains the PROCID. Otherwise, NameLenProcID contains   |
|           | the parameter name length and parameter name.            |
+-----------+----------------------------------------------------------+
| Op        | Bit flags in [least significant bit                      |
| tionFlags | order](#Section_bbc22f15e1a04338a169c79819d39b1c):       |
|           |                                                          |
|           | -   fWithRecomp: 1 if RPC is sent with the \"with        |
|           |     recompile\" option.                                  |
|           |                                                          |
|           | -   fNoMetaData: The server sends NoMetaData only if     |
|           |     fNoMetaData is set to 1 in the request (see          |
|           |     COLMETADATA, section                                 |
|           |     [2.2.7.4](                                           |
|           | #Section_58880b9f381c43b2bf8b0727a98c4f4c)).[\<39\>](\l) |
|           |                                                          |
|           | -   fReuseMetaData: 1 if the metadata has not changed    |
|           |     from the previous call and the server SHOULD reuse   |
|           |     its cached metadata (the metadata MUST still be      |
|           |     sent).                                               |
+-----------+----------------------------------------------------------+
| St        | Bit flags in least significant bit order:                |
| atusFlags |                                                          |
|           | -   fByRefValue: 1 if the parameter is passed by         |
|           |     reference (OUTPUT parameter) or 0 if parameter is    |
|           |     passed by value.                                     |
|           |                                                          |
|           | -   fDefaultValue: 1 if the parameter being passed is to |
|           |     be the default value.                                |
|           |                                                          |
|           | -   fEncrypted: 1 if the parameter that is being passed  |
|           |     is encrypted. This flag is valid only when the       |
|           |     column encryption feature is negotiated by client    |
|           |     and server and is turned on.                         |
+-----------+----------------------------------------------------------+
| Para      | The parameter name length and parameter name (within     |
| meterData | B_VARCHAR), the TYPE_INFO of the RPC data, and the       |
|           | type-dependent data for the RPC (within TYPE_VARBYTE).   |
+-----------+----------------------------------------------------------+
| Encry     | This byte describes the encryption algorithm that is     |
| ptionAlgo | used. For a custom encryption algorithm, the             |
|           | EncryptionAlgo value MUST be set to 0 and the actual     |
|           | encryption algorithm MUST be inferred from the AlgoName. |
|           | For all other values, AlgoName MUST NOT be sent.         |
|           |                                                          |
|           | If the value is set to 1, the encryption algorithm that  |
|           | is used is AEAD_AES_256_CBC_HMAC_SHA512, as described in |
|           | [\[IETF-Aut                                              |
|           | hEncr\]](https://go.microsoft.com/fwlink/?LinkId=524322) |
|           | section 5.4.                                             |
+-----------+----------------------------------------------------------+
| AlgoName  | Algorithm name literal that is used for encrypting the   |
|           | plaintext value. This is an optional field and MUST be   |
|           | sent when EncryptionAlgo = 0. For all other values of    |
|           | EncryptionAlgo, this field MUST NOT be sent.             |
+-----------+----------------------------------------------------------+
| Encry     | This byte describes the flavor of encryption algorithm   |
| ptionType | that is used. The values of this field are as follows:   |
|           |                                                          |
|           | 1 = deterministic encryption.                            |
|           |                                                          |
|           | 2 = randomized encryption.                               |
+-----------+----------------------------------------------------------+
| No        | Reserved for future use. The value MUST be set to 1.     |
| rmVersion |                                                          |
+-----------+----------------------------------------------------------+
| D         | A 4-byte integer value that represents the database ID   |
| atabaseId | where the column encryption key is stored.               |
+-----------+----------------------------------------------------------+
| CekId     | An identifier for the column encryption key.             |
+-----------+----------------------------------------------------------+
| C         | The key version of the column encryption key.            |
| ekVersion |                                                          |
+-----------+----------------------------------------------------------+
| Cek       | The metadata version for the column encryption key.      |
| MDVersion |                                                          |
+-----------+----------------------------------------------------------+
| ParamC    | The description of the parameter encryption information  |
| ipherInfo | when the parameter is transparently encrypted. It        |
|           | defines the original TYPE_INFO of the data that is       |
|           | encrypted, the encryption algorithm that is used, the    |
|           | normalization version, the id of the database containing |
|           | the column encryption key used for encryption, the id of |
|           | the column encryption key, the version of the column     |
|           | encryption key, and the version of the column encryption |
|           | key metadata. These fields MUST be sent only when        |
|           | fEncrypted is set to 1.                                  |
+-----------+----------------------------------------------------------+
| Encla     | An encrypted byte package that SHOULD[\<40\>](\l) be     |
| vePackage | generated by the client. This package contains           |
|           | information that is required by the server-side          |
|           | [**enclave**](#gt_ef41e9e0-3e5d-432f-96d6-39515bdc5340)  |
|           | to perform computations on encrypted columns. The        |
|           | package has an internal structure that is irrelevant to  |
|           | the TDS protocol between client and server. The server   |
|           | forwards the byte array to the enclave without           |
|           | interpreting it, and the enclave decodes the byte array. |
|           |                                                          |
|           | Introduced in TDS 7.4.                                   |
+-----------+----------------------------------------------------------+
| BatchFlag | Distinguishes the start of the next RPC from another     |
|           | parameter within the current RPC. If the version of TDS  |
|           | in use supports these flags, either the **BatchFlag**    |
|           | element or the **NoExecFlag** element MUST be present    |
|           | when another RPC request is in the current batch.        |
|           | BatchFlag SHOULD NOT be sent after the last RPCReqBatch. |
|           | If BatchFlag is received after the last RPCReqBatch is   |
|           | received, the server MUST ignore it.                     |
+-----------+----------------------------------------------------------+
| N         | Indicates that the preceding RPC is not executed. If     |
| oExecFlag | this separator is found, the previous RPC is not         |
|           | executed. Instead, an error message is returned,         |
|           | followed by the DONEPROC marking that the RPC in the     |
|           | batch has finished, and then execution proceeds to the   |
|           | next RPC in the batch. The tabular data set returned is  |
|           | very similar to what happens if the RPC does not         |
|           | exist---never execute the RPC, just return an error      |
|           | message, followed by DONEPROC, and then execute the next |
|           | RPC.                                                     |
+-----------+----------------------------------------------------------+

#### SQLBatch

**Stream Name:**

822. SQLBatch

**Stream Function:**

Describes the format of the SQL Batch message.

**Stream Comments:**

-   Packet header type 0x01.

-   A sample SQLBatch message is in section
    [4.6](#Section_b05b006b3cbf404bbcaf7ec584b54706).

**Stream-Specific Rules:**

823. SQLText = UNICODESTREAM

**Stream Definition:**

824. SQLBatch = ALL_HEADERS

     \*EnclavePackage ; (described in section 2.2.6.6)

     SQLText

The [**Unicode**](#gt_c305d0ab-8b94-461a-bd76-13b40cb8c4d8) stream
contains the text of the batch. The following is an example of a valid
value for SQLText.

827. Select author_id from Authors

#### SSPI Message

**Stream Name:**

828. SSPI

**Stream Function:**

A request to supply data for [**Security Support Provider Interface
(SSPI)**](#gt_fb216516-748b-4873-8bdd-64c5f4da9920) security. Note that
SSPI uses the [**Simple and Protected GSS-API Negotiation Mechanism
(SPNEGO)**](#gt_bc2f6b5e-e5c0-408b-8f55-0350c24b9838)
[\[RFC4178\]](https://go.microsoft.com/fwlink/?LinkId=90461)
negotiation.

**Stream Comments:**

-   Packet header type 0x11.

-   The initial SSPI data block (the initial SPNEGO security token) is
    sent from the client to the server in the LOGIN7 message. The server
    MUST respond with an SSPI token that is the SPNEGO security token
    response from the server. The client MUST respond with another SSPI
    message, after calling the SPNEGO
    [**interface**](#gt_95913fbd-3262-47ae-b5eb-18e6806824b9) with the
    server\'s response.

-   This continues until completion or an error.

-   The server completes the SSPI validation and returns the last SPNEGO
    security token as an SSPI token within a LOGINACK token.

-   A sample SSPI message is in section
    [4.11](#Section_dc57840ad13b43a1aad35425afadbc0c).

**Stream-Specific Rules:**

829. SSPIData = BYTESTREAM

**Stream Definition:**

830. SSPI = SSPIData

**Stream Parameter Details**

  -----------------------------------------------------------------------
  Parameter    Description
  ------------ ----------------------------------------------------------
  SSPIData     The SSPIData length and SSPIData data using US_VARCHAR
               format.

  -----------------------------------------------------------------------

#### Transaction Manager Request

**Stream Name:**

831. TransMgrReq

**Stream Function:**

Query and control operations pertaining to the lifecycle and state of
local and distributed transaction objects. Note that distributed
transaction operations are coordinated through a [**Distributed
Transaction Coordinator
(DTC)**](#gt_177a71e6-7cf0-48c1-b169-063da349648a) implemented to the
DTC Interface Specification. For more information about DTC, see
[\[MSDN-DTC\]](https://go.microsoft.com/fwlink/?LinkId=89994).

**Stream Comments:**

-   Packet header type 0x0E.

-   A sample Transaction Manager Request message is given in section
    [4.13](#Section_9f10990a9c744a3989da2a3b05effacb).

**Stream-Specific Rules:**

832. RequestType = USHORT

**Stream Definition:**

833. TransMgrReq = ALL_Headers

     RequestType

     \[RequestPayload\]

RequestPayload details are as specified in the following table.

**Stream Parameter Details**

+----------+-----------------------------------------------------------+
| P        | Description                                               |
| arameter |                                                           |
+==========+===========================================================+
| Req      | The types of [**transaction                               |
| uestType | manager**](#gt_4553803e-9d8d-407c-ad7d-9e65e01d6eb3)      |
|          | operations that are requested by the client are specified |
|          | as follows. If an unknown Type is specified, the message  |
|          | receiver SHOULD disconnect the connection.                |
|          |                                                           |
|          | -   0 = TM_GET_DTC_ADDRESS. Returns DTC network address   |
|          |     as a [**result                                        |
|          |     set**](#gt_c8a27238-8ccc-442b-9604-75f74d3e6b3d) with |
|          |     a single-column, single-row binary value.             |
|          |                                                           |
|          | -   1 = TM_PROPAGATE_XACT. Imports DTC transaction into   |
|          |     the server and returns a local transaction descriptor |
|          |     as a varbinary result set.                            |
|          |                                                           |
|          | -   5 = TM_BEGIN_XACT. Begins a transaction and returns   |
|          |     the descriptor in an ENVCHANGE type 8.                |
|          |                                                           |
|          | -   6 = TM_PROMOTE_XACT. Converts an active local         |
|          |     transaction into a distributed transaction and        |
|          |     returns an opaque buffer in an ENVCHANGE type 15.     |
|          |                                                           |
|          | -   7 = TM_COMMIT_XACT. Commits a transaction. Depending  |
|          |     on the payload of the request, it can additionally    |
|          |     request that another local transaction be started.    |
|          |                                                           |
|          | -   8 = TM_ROLLBACK_XACT. Rolls back a transaction.       |
|          |     Depending on the payload of the request, it can       |
|          |     indicate that after the rollback, a local transaction |
|          |     is to be started.                                     |
|          |                                                           |
|          | -   9 = TM_SAVE_XACT. Sets a savepoint within the active  |
|          |     transaction. This request MUST specify a nonempty     |
|          |     name for the savepoint.                               |
|          |                                                           |
|          | Request types 5 through 9 were introduced in TDS 7.2.     |
+----------+-----------------------------------------------------------+
| Reques   | -   For RequestType TM_GET_DTC_ADDRESS: The               |
| tPayload |     RequestPayload SHOULD be a zero-length US_VARBYTE.    |
|          |                                                           |
|          | 836. RequestPayload = US_VARBYTE                          |
|          |                                                           |
|          | -   For RequestType TM_PROPAGATE_XACT: Data contains an   |
|          |     opaque buffer used by the server to enlist in a DTC   |
|          |     transaction (for more information, see                |
|          |     [\[MSDN-IT                                            |
|          | rans\]](https://go.microsoft.com/fwlink/?LinkId=146594)). |
|          |                                                           |
|          | 837. RequestPayload = US_VARBYTE                          |
|          |                                                           |
|          | -   For RequestType TM_BEGIN_XACT:                        |
|          |                                                           |
|          | 838. ISOLATION_LEVEL = BYTE                               |
|          |                                                           |
|          |      BEGIN_XACT_NAME = B_VARBYTE                          |
|          |                                                           |
|          |      RequestPayload = ISOLATION_LEVEL                     |
|          |                                                           |
|          |      BEGIN_XACT_NAME                                      |
|          |                                                           |
|          | This request begins a new transaction, or increments      |
|          | trancount if already in a transaction. If BEGIN_XACT_NAME |
|          | is nonempty, a transaction is started with the specified  |
|          | name. See the definition for isolation level at the end   |
|          | of this table.                                            |
|          |                                                           |
|          | -   For RequestType TM_PROMOTE_XACT -- No payload.        |
|          |                                                           |
|          | This message promotes the transaction of the current      |
|          | request (specified in the Transaction Descriptor header,  |
|          | section                                                   |
|          | [2.2.5.3.2](#Section_4257dd95ef6c4621b75d270738487d68)).  |
|          | The current transaction MUST be part of the specified     |
|          | header.                                                   |
|          |                                                           |
|          | Note that TM_PROMOTE_XACT is supported only for           |
|          | transactions initiated via TM_BEGIN_XACT, or via piggy    |
|          | back operation on TM_COMMIT/TM_ROLLBACK. An error is      |
|          | returned if TM_PROMOTE_XACT is invoked for a TSQL         |
|          | initiated transaction.                                    |
|          |                                                           |
|          | -   For RequestType TM_COMMIT_XACT:                       |
|          |                                                           |
|          | 843. fBeginXact = BIT                                     |
|          |                                                           |
|          |      XACT_FLAGS = fBeginXact                              |
|          |                                                           |
|          |      7FRESERVEDBIT                                        |
|          |                                                           |
|          |      ISOLATION_LEVEL = BYTE                               |
|          |                                                           |
|          |      XACT_NAME = B_VARBYTE                                |
|          |                                                           |
|          |      BEGIN_XACT_NAME = B_VARBYTE                          |
|          |                                                           |
|          |      RequestPayload = XACT_NAME                           |
|          |                                                           |
|          |      XACT_FLAGS                                           |
|          |                                                           |
|          |      \[ISOLATION_LEVEL                                    |
|          |                                                           |
|          |      BEGIN_XACT_NAME\]                                    |
|          |                                                           |
|          | Without additional flags specified, this command is       |
|          | semantically equivalent to issuing a TSQL COMMIT          |
|          | statement.                                                |
|          |                                                           |
|          | The flags in XACT_FLAGS are represented in [least         |
|          | significant bit                                           |
|          | order](#Section_bbc22f15e1a04338a169c79819d39b1c).        |
|          |                                                           |
|          | If fBeginXact is 1, then a new local transaction is       |
|          | started after the commit operation is done.               |
|          |                                                           |
|          | If fBeginXact is 1, then ISOLATION_LEVEL can specify the  |
|          | isolation level to use to start the new transaction,      |
|          | according to the definition at the end of this table. If  |
|          | fBeginXact is 0, then ISOLATION_LEVEL SHOULD NOT be       |
|          | present.                                                  |
|          |                                                           |
|          | Specifying ISOLATION_LEVEL allows the isolation level to  |
|          | remain in effect for the session, once the transaction    |
|          | ends.                                                     |
|          |                                                           |
|          | If fBeginXact is 0, BEGIN_XACT_NAME SHOULD NOT be         |
|          | present. If fBeginXact is 1, BEGIN_XACT_NAME can be       |
|          | nonempty.                                                 |
|          |                                                           |
|          | If fBeginXact is 1, a new transaction MUST be started. If |
|          | BEGIN_XACT_NAME is nonempty, the new transaction MUST be  |
|          | given the specified name.                                 |
|          |                                                           |
|          | See the definition for isolation level at the end of this |
|          | table.                                                    |
|          |                                                           |
|          | -   For RequestType TM_ROLLBACK_XACT:                     |
|          |                                                           |
|          | 857. fBeginXact = BIT                                     |
|          |                                                           |
|          |      XACT_FLAGS = fBeginXact                              |
|          |                                                           |
|          |      7FRESERVEDBIT                                        |
|          |                                                           |
|          |      ISOLATION_LEVEL = BYTE                               |
|          |                                                           |
|          |      XACT_NAME = B_VARBYTE                                |
|          |                                                           |
|          |      BEGIN_XACT_NAME = B_VARBYTE                          |
|          |                                                           |
|          |      RequestPayload = XACT_NAME                           |
|          |                                                           |
|          |      XACT_FLAGS                                           |
|          |                                                           |
|          |      \[ISOLATION_LEVEL                                    |
|          |                                                           |
|          |      BEGIN_XACT_NAME\]                                    |
|          |                                                           |
|          | The flags in XACT_FLAGS are represented in least          |
|          | significant bit order.                                    |
|          |                                                           |
|          | If XACT_NAME is nonempty, this request rolls back the     |
|          | named transaction. This implies that if XACT_NAME         |
|          | specifies a savepoint name, the rollback only goes back   |
|          | until the specified savepoint.                            |
|          |                                                           |
|          | Without additional flags specified, this command is       |
|          | semantically equivalent to issuing a TSQL ROLLBACK        |
|          | statement under the current transaction.                  |
|          |                                                           |
|          | If fBeginXact is 1, then a new local transaction is       |
|          | started after the commit operation is done.               |
|          |                                                           |
|          | If fBeginXact is 1, then ISOLATION_LEVEL can specify the  |
|          | isolation level to use to start the new transaction,      |
|          | according to the definition at the end of this table. If  |
|          | fBeginXact is 0, then ISOLATION_LEVEL SHOULD NOT be       |
|          | present.                                                  |
|          |                                                           |
|          | Specifying ISOLATION_LEVEL allows the isolation level to  |
|          | remain in effect for the session, once the transaction    |
|          | ends.                                                     |
|          |                                                           |
|          | If fBeginXact is 0, BEGIN_XACT_NAME SHOULD NOT be         |
|          | present. If fBeginXact is 1, BEGIN_XACT_NAME can be       |
|          | nonempty.                                                 |
|          |                                                           |
|          | If fBeginXact is 1, a new transaction MUST be started. If |
|          | BEGIN_XACT_NAME is nonempty, the new transaction MUST be  |
|          | given the specified name.                                 |
|          |                                                           |
|          | If fBeginXact is 1, and the ROLLBACK only rolled back to  |
|          | a savepoint, the Begin_Xact operation is ignored and      |
|          | trancount remains unchanged.                              |
|          |                                                           |
|          | See the definition for isolation level at the end of this |
|          | table.                                                    |
|          |                                                           |
|          | -   For RequestType TM_SAVE_XACT:                         |
|          |                                                           |
|          | 871. XACT_SAVEPOINT_NAME = B_VARBYTE                      |
|          |                                                           |
|          |      RequestPayload = XACT_SAVEPOINT_NAME                 |
|          |                                                           |
|          | A nonempty name MUST be specified as part of this         |
|          | request. Otherwise, an error is raised.                   |
+----------+-----------------------------------------------------------+

ISOLATION_LEVEL MUST have one of the following values.

  -----------------------------------------------------------------------
  Value      Description
  ---------- ------------------------------------------------------------
  0x00       No isolation level change requested. Use current.

  0x01       Read Uncommitted.

  0x02       Read Committed.

  0x03       Repeatable Read.

  0x04       Serializable.

  0x05       Snapshot.
  -----------------------------------------------------------------------

